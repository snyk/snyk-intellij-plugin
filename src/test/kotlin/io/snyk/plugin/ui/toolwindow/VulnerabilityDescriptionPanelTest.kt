package io.snyk.plugin.ui.toolwindow

import com.google.gson.Gson
import com.intellij.ui.components.labels.LinkLabel
import junit.framework.TestCase.assertEquals
import junit.framework.TestCase.assertNotNull
import org.junit.Before
import org.junit.Test
import snyk.UIComponentFinder.getJLabelByText
import snyk.oss.Vulnerability
import java.io.FileReader
import javax.swing.JLabel

class VulnerabilityDescriptionPanelTest {
    private lateinit var cut: VulnerabilityDescriptionPanel
    private lateinit var vulnerability: Vulnerability

    @Before
    fun setup() {
        val gson = Gson()
        val json = FileReader("src/test/resources/npm-test-vulnerability.json")
        vulnerability = gson.fromJson(json, Vulnerability::class.java)
        cut = VulnerabilityDescriptionPanel(listOf(vulnerability))
    }

    @Test
    fun `constructor should build panel with npm introduced-from info as link label`() {
        val introducingDependency = vulnerability.from[1]
        val actual = getJLabelByText(cut, introducingDependency)
        assertNotNull(actual)
        assertEquals(LinkLabel::class, actual!!::class)
    }

    @Test
    fun `constructor should build panel with non-npm introduced-from info as plain text label`() {
        val introducingDependency = vulnerability.from[1]
        vulnerability = vulnerability.copy(packageManager = "not npm!")
        cut = VulnerabilityDescriptionPanel(listOf(vulnerability))
        val actual = getJLabelByText(cut, introducingDependency)
        assertNotNull(actual)
        assertEquals(JLabel::class, actual!!::class)
    }

    @Test
    fun `constructor should build panel with all CWEs as link labels`() {
        val cwes = vulnerability.identifiers!!.cwe
        cwes.forEach { cwe ->
            val actual = getJLabelByText(cut, cwe)
            assertNotNull("Expected to find label for $cwe, but was null", actual)
        }
    }
}
