package io.snyk.plugin.ui.toolwindow.panels

import com.intellij.ui.components.labels.LinkLabel
import com.intellij.uiDesigner.core.GridLayoutManager
import io.snyk.plugin.ui.DescriptionHeaderPanel
import io.snyk.plugin.ui.addRowOfItemsToPanel
import io.snyk.plugin.ui.baseGridConstraintsAnchorWest
import io.snyk.plugin.ui.boldLabel
import io.snyk.plugin.ui.descriptionHeaderPanel
import io.snyk.plugin.ui.getReadOnlyClickableHtmlJEditorPane
import io.snyk.plugin.ui.insertTitleAndResizableTextIntoPanelColumns
import io.snyk.plugin.ui.panelGridConstraints
import io.snyk.plugin.ui.toolwindow.LabelProvider
import org.commonmark.parser.Parser
import org.commonmark.renderer.html.HtmlRenderer
import snyk.oss.Vulnerability
import java.awt.Insets
import javax.swing.JLabel
import javax.swing.JPanel

class VulnerabilityDescriptionPanel(
    private val groupedVulns: Collection<Vulnerability>
) : IssueDescriptionPanelBase(
    title = groupedVulns.first().title,
    severity = groupedVulns.first().getSeverity()
) {

    private val labelProvider: LabelProvider = LabelProvider()
    private val vulnerability = groupedVulns.first()

    init {
        createUI()
    }

    override fun createMainBodyPanel(): Pair<JPanel, Int> {
        val lastRowToAddSpacer = 4
        val panel = JPanel(
            GridLayoutManager(lastRowToAddSpacer + 1, 1, Insets(0, 10, 20, 20), -1, 10)
        ).apply {
            this.add(
                getMainBodyPanel(),
                baseGridConstraintsAnchorWest(1, indent = 0)
            )
            this.add(
                getDetailedPathsPanel(),
                panelGridConstraints(2)
            )
            this.add(
                getOverviewPanel(),
                panelGridConstraints(3)
            )
        }
        return Pair(panel, lastRowToAddSpacer)
    }

    private fun getMainBodyPanel(): JPanel {
        val panel = JPanel()
        panel.layout = GridLayoutManager(11, 2, Insets(10, 0, 20, 0), 30, -1)

        panel.add(
            boldLabel("Vulnerable module:"),
            baseGridConstraintsAnchorWest(2, 0)
        )
        panel.add(
            JLabel(vulnerability.name)/*.apply { this.horizontalAlignment = SwingConstants.LEFT }*/,
            baseGridConstraintsAnchorWest(2, 1, indent = 0)
        )

        val introducedThroughListPanel = getIntroducedThroughListPanel()
        if (introducedThroughListPanel != null) {
            panel.add(
                boldLabel("Introduced through:"),
                baseGridConstraintsAnchorWest(3, 0)
            )
            panel.add(
                introducedThroughListPanel,
                baseGridConstraintsAnchorWest(3, 1, indent = 0)
            )
        }

        val fixedInText = vulnerability.fixedIn?.let {
            if (it.isNotEmpty()) {
                it.joinToString(prefix = "${vulnerability.name}@", separator = ", @")
            } else "Not fixed"
        }
        if (fixedInText != null) {
            panel.add(
                boldLabel("Fixed in:"),
                baseGridConstraintsAnchorWest(4, 0)
            )
            panel.add(
                JLabel(fixedInText),
                baseGridConstraintsAnchorWest(4, 1, indent = 0)
            )
        }

        val exploit = vulnerability.exploit
        if (exploit != null) {
            panel.add(
                boldLabel("Exploit maturity:"),
                baseGridConstraintsAnchorWest(5, 0)
            )
            panel.add(
                JLabel(exploit),
                baseGridConstraintsAnchorWest(5, 1, indent = 0)
            )
        }

        return panel
    }

    private fun getIntroducedThroughListPanel(): JPanel? {
        val intros = groupedVulns
            .mapNotNull { vulnerability ->
                vulnerability.from.let { if (it.size > 1) it[1] else null }
            }
            .distinct()

        if (intros.isEmpty()) return null

        val panel = JPanel()
        val packageManager = groupedVulns.first().packageManager

        panel.layout = GridLayoutManager(1, intros.size * 2, Insets(0, 0, 0, 0), 0, 0)

        addRowOfItemsToPanel(
            panel = panel,
            startingColumn = 0,
            items = intros.map { item -> labelProvider.getDependencyLabel(packageManager, item) },
            separator = ", ",
            firstSeparator = false,
            opaqueSeparator = false
        )
        return panel
    }

    private fun getDetailedPathsPanel(): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, -1)

        detailsPanel.add(
            boldLabel("Detailed paths").apply {
                font = font.deriveFont(14f)
            },
            baseGridConstraintsAnchorWest(
                row = 0
            )
        )

        detailsPanel.add(
            getInnerDetailedPathsPanel(3),
            panelGridConstraints(
                row = 1
            )
        )

        return detailsPanel
    }

    private fun getInnerDetailedPathsPanel(itemsToShow: Int? = null): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(groupedVulns.size + 2, 2, Insets(0, 0, 0, 0), -1, -1)

        groupedVulns
            .take(itemsToShow ?: groupedVulns.size)
            .forEachIndexed { index, vuln ->
                val detailPanel = JPanel()
                detailPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), 30, 0)

                insertTitleAndResizableTextIntoPanelColumns(
                    panel = detailPanel,
                    row = 0,
                    title = "Introduced through:",
                    htmlText = vuln.from.joinToString(separator = " > ")
                )

                val remediationText = when {
                    vuln.upgradePath.isEmpty() || vuln.upgradePath.size < 2 -> "none"
                    else -> "Upgrade to " + vuln.upgradePath[1]
                }
                insertTitleAndResizableTextIntoPanelColumns(
                    panel = detailPanel,
                    row = 1,
                    title = "Fix:",
                    htmlText = remediationText
                )

                detailsPanel.add(
                    detailPanel,
                    panelGridConstraints(
                        row = index + 1
                    )
                )
            }

        if (itemsToShow != null && itemsToShow < groupedVulns.size) {
            val showMoreLabel = LinkLabel.create("...and ${groupedVulns.size - itemsToShow} more") {
                detailsPanel.removeAll()
                detailsPanel.add(
                    getInnerDetailedPathsPanel(),
                    panelGridConstraints(
                        row = 0
                    )
                )
            }
            detailsPanel.add(
                showMoreLabel,
                baseGridConstraintsAnchorWest(groupedVulns.size + 1)
            )
        }

        return detailsPanel
    }

    private fun getOverviewPanel(): JPanel {
        val overviewPanel = JPanel()
        overviewPanel.layout = GridLayoutManager(2, 1, Insets(0, 5, 0, 0), -1, 0)

        val descriptionPane = getReadOnlyClickableHtmlJEditorPane(getDescriptionAsHtml())

        overviewPanel.add(
            descriptionPane,
            panelGridConstraints(1)
        )
        return overviewPanel
    }

    private fun getDescriptionAsHtml(): String {
        val overviewMarkdownStr = vulnerability.description

        val parser = Parser.builder().build()
        val document = parser.parse(overviewMarkdownStr)

        val renderer = HtmlRenderer.builder().escapeHtml(true).build()

        return renderer.render(document)
    }

    override fun secondRowTitlePanel(): DescriptionHeaderPanel = descriptionHeaderPanel(
        issueNaming = if (vulnerability.license == null) "Vulnerability" else "License",
        cwes = vulnerability.identifiers?.cwe ?: emptyList(),
        cves = vulnerability.identifiers?.cve ?: emptyList(),
        cvssScore = vulnerability.cvssScore,
        cvssV3 = vulnerability.cvssV3,
        id = vulnerability.id
    )
}
