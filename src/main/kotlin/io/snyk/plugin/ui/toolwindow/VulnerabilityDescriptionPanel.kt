package io.snyk.plugin.ui.toolwindow

import com.intellij.ide.BrowserUtil
import com.intellij.ui.BrowserHyperlinkListener
import com.intellij.ui.ColorUtil
import com.intellij.ui.components.labels.LinkLabel
import com.intellij.uiDesigner.core.GridConstraints
import com.intellij.uiDesigner.core.GridLayoutManager
import com.intellij.uiDesigner.core.Spacer
import com.intellij.util.ui.JBHtmlEditorKit
import com.intellij.util.ui.JBUI
import com.intellij.util.ui.UIUtil
import icons.SnykIcons
import io.snyk.plugin.cli.Vulnerability
import io.snyk.plugin.ui.buildBoldTitleLabel
import io.snyk.plugin.ui.buildTwoLabelsPanel
import org.commonmark.parser.Parser
import org.commonmark.renderer.html.HtmlRenderer
import java.awt.*
import javax.swing.*
import javax.swing.text.html.HTMLDocument


class VulnerabilityDescriptionPanel(private val groupedVulns: Collection<Vulnerability>) : JPanel() {

    private val vulnerability = groupedVulns.first()

    private fun baseGridConstraints(
        row: Int,
        column: Int = 0,
        rowSpan: Int = 1,
        colSpan: Int = 1,
        anchor: Int = GridConstraints.ANCHOR_WEST,
        fill: Int = GridConstraints.FILL_NONE,
        HSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        VSizePolicy: Int = GridConstraints.SIZEPOLICY_FIXED,
        minimumSize: Dimension? = null,
        preferredSize: Dimension? = null,
        maximumSize: Dimension? = null,
        indent: Int = 1,
        useParentLayout: Boolean = false
    ): GridConstraints {
        return GridConstraints(
            row, column, rowSpan, colSpan, anchor, fill, HSizePolicy, VSizePolicy, minimumSize, preferredSize,
            maximumSize, indent, useParentLayout
        )
    }

    private fun panelGridConstraints(row: Int) = baseGridConstraints(
        row = row,
        anchor = GridConstraints.ANCHOR_CENTER,
        fill = GridConstraints.FILL_BOTH,
        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK or GridConstraints.SIZEPOLICY_CAN_GROW,
        indent = 0
    )

    init {
        this.layout = GridLayoutManager(10, 1, Insets(20, 10, 20, 20), -1, 10)

        this.add(
            Spacer(),
            baseGridConstraints(
                9,
                anchor = GridConstraints.ANCHOR_CENTER,
                fill = GridConstraints.FILL_VERTICAL,
                HSizePolicy = GridConstraints.SIZEPOLICY_CAN_SHRINK,
                VSizePolicy = GridConstraints.SIZEPOLICY_WANT_GROW,
                indent = 0
            )
        )

        this.add(
            getMainBodyPanel(),
            baseGridConstraints(1, indent = 0)
        )

        this.add(
            getDetailedPathsPanel(),
            panelGridConstraints(2)
        )

        this.add(
            getOverviewPanel(),
            panelGridConstraints(3)
        )

        this.add(
            getTitlePanel(),
            panelGridConstraints(0)
        )
    }

    private fun getMainBodyPanel(): JPanel {
        val panel = JPanel()
        panel.layout = GridLayoutManager(11, 2, Insets(20, 0, 20, 0), 50, -1)

        fun boldLabel(text: String) = JLabel(text).apply { font = io.snyk.plugin.ui.getFont(Font.BOLD, -1, JLabel().font) }

        panel.add(
            boldLabel("Vulnerable module:"),
            baseGridConstraints(2, 0)
        )
        panel.add(
            JLabel(vulnerability.name)/*.apply { this.horizontalAlignment = SwingConstants.LEFT }*/,
            baseGridConstraints(2, 1)
        )

        val introducedThroughListPanel = getIntroducedThroughListPanel()
        if (introducedThroughListPanel != null) {
            panel.add(
                boldLabel("Introduced through:"),
                baseGridConstraints(3, 0)
            )
            panel.add(
                introducedThroughListPanel,
                baseGridConstraints(3, 1)
            )
        }

        val fixedInText = vulnerability.fixedIn?.let {
            if (it.isNotEmpty()) {
                it.joinToString(prefix = "${vulnerability.name}@", separator = ", @")
            } else "Not fixed"
        }
        if (fixedInText != null) {
            panel.add(
                boldLabel("Fixed in:"),
                baseGridConstraints(4, 0)
            )
            panel.add(
                JLabel(fixedInText),
                baseGridConstraints(4, 1)
            )
        }

        val exploit = vulnerability.exploit
        if (exploit != null) {
            panel.add(
                boldLabel("Exploit maturity:"),
                baseGridConstraints(5, 0)
            )
            panel.add(
                JLabel(exploit),
                baseGridConstraints(5, 1)
            )
        }

        return panel
    }

    private fun getIntroducedThroughListPanel(): JPanel? {
        val intros = groupedVulns
            .mapNotNull { vulnerability ->
                vulnerability.from.let { if (it.size > 1) it[1] else null }
            }
            .distinct()

        if (intros.isEmpty()) return null

        val panel = JPanel()
        val packageManager = groupedVulns.first().packageManager

        panel.layout = GridLayoutManager(1, intros.size * 2, Insets(0, 0, 0, 0), 0, 0)

        addRowOfItemsToPanel(
            panel = panel,
            startingColumn = 0,
            items = intros.toTypedArray(),
            separator = ", ",
            firstSeparator = false,
            opaqueSeparator = false
        ) { "https://app.snyk.io/test/$packageManager/$it" }
        return panel
    }

    private fun getDetailedPathsPanel(): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, -1)

        detailsPanel.add(
            buildBoldTitleLabel("Detailed paths"),
            baseGridConstraints(
                row = 0
            )
        )

        detailsPanel.add(
            getInnerDetailedPathsPanel(3),
            baseGridConstraints(
                row = 1,
                indent = 0
            )
        )

        return detailsPanel
    }

    private fun getInnerDetailedPathsPanel(itemsToShow: Int? = null): JPanel {
        val detailsPanel = JPanel()
        detailsPanel.layout = GridLayoutManager(groupedVulns.size + 2, 2, Insets(0, 0, 0, 0), -1, -1)

        groupedVulns
            .take(itemsToShow ?: groupedVulns.size)
            .forEachIndexed { index, vuln ->
                val detailPanel = JPanel()
                detailPanel.layout = GridLayoutManager(2, 2, Insets(0, 0, 0, 0), -1, 0)
                detailPanel.add(buildTwoLabelsPanel("Introduced through:", vuln.from.joinToString(separator = " > ")),
                    baseGridConstraints(
                        row = 0,
                        HSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        VSizePolicy = GridConstraints.SIZEPOLICY_CAN_GROW or GridConstraints.SIZEPOLICY_CAN_SHRINK,
                        indent = 0
                    )
                )

                val remediationText = when {
                    vuln.upgradePath.isEmpty() || vuln.upgradePath.size < 2 -> "none"
                    else -> "Upgrade to " + vuln.upgradePath[1]
                }
                detailPanel.add(
                    buildTwoLabelsPanel("Remediation:", remediationText),
                    baseGridConstraints(
                        row = 1,
                        indent = 0
                    )
                )

                detailsPanel.add(
                    detailPanel,
                    baseGridConstraints(
                        row = index + 1
                    )
                )
            }

        if (itemsToShow != null && itemsToShow < groupedVulns.size) {
            val showMoreLabel = LinkLabel.create("...and ${groupedVulns.size - itemsToShow} more") {
                detailsPanel.removeAll()
                detailsPanel.add(
                    getInnerDetailedPathsPanel(),
                    baseGridConstraints(
                        row = 0,
                        indent = 0
                    )
                )
                this.revalidate()
                this.repaint()
            }
            detailsPanel.add(
                showMoreLabel,
                baseGridConstraints(groupedVulns.size + 1)
            )
        }

        return detailsPanel
    }

    private fun getTitlePanel(): JPanel {
        val titlePanel = JPanel()
        titlePanel.layout = GridLayoutManager(2, 1, Insets(0, 0, 0, 0), -1, 5)

        val titleLabel = JLabel().apply {
            font = io.snyk.plugin.ui.getFont(Font.BOLD, 20, font)
            text = " ${vulnerability.title}"
            icon = SnykIcons.getSeverityIcon(vulnerability.severity, SnykIcons.IconSize.SIZE24)
        }

        titlePanel.add(
            titleLabel,
            baseGridConstraints(0)
        )

        titlePanel.add(
            cwePanel(),
            baseGridConstraints(1, indent = 0)
        )

        return titlePanel
    }

    private fun cwePanel(): Component {
        val panel = JPanel()
        val cwes = vulnerability.identifiers?.CWE ?: emptyArray()
        val cves = vulnerability.identifiers?.CVE ?: emptyArray()

        val columnCount = 1 + // `Vulnerability`/`License` label
            cwes.size * 2 + // CWEs with `|`
            cves.size * 2 + // CVEs with `|`
            2 + // CVSS
            2 // Snyk description
        panel.layout = GridLayoutManager(1, columnCount, Insets(0, 0, 0, 0), 5, 0)

        panel.add(
            JLabel(if (vulnerability.license == null) "Vulnerability" else "License"),
            baseGridConstraints(0)
        )

        var lastColumn =
            addRowOfItemsToPanel(panel, 0, cwes) { "https://cwe.mitre.org/data/definitions/${it.removePrefix("CWE-")}.html" }

        lastColumn =
            addRowOfItemsToPanel(panel, lastColumn, cves) { "https://cve.mitre.org/cgi-bin/cvename.cgi?name=$it" }

        val cvssScore = vulnerability.cvssScore
        val cvsSv3 = vulnerability.CVSSv3
        if (cvssScore != null && cvsSv3 != null) {
            lastColumn =
                addRowOfItemsToPanel(panel, lastColumn, arrayOf("CVSS $cvssScore")) { "https://www.first.org/cvss/calculator/3.1#$cvsSv3" }
        }

        lastColumn =
            addRowOfItemsToPanel(panel, lastColumn,
                arrayOf(vulnerability.id.toUpperCase())
            ) { "https://snyk.io/vuln/${vulnerability.id}" }

        return panel
    }

    private fun addRowOfItemsToPanel(
        panel: JPanel,
        startingColumn: Int,
        items: Array<String>,
        separator: String = " | ",
        firstSeparator: Boolean = true,
        opaqueSeparator: Boolean = true,
        buildUrl: (String) -> String
    ): Int {
        var currentColumn = startingColumn
        items.forEachIndexed() { index, item ->
            if (item.isNotEmpty()) {
                val positionLabel = LinkLabel.create(item) {
                    val url = buildUrl(item)
                    BrowserUtil.open(url)
                }
                if (currentColumn != startingColumn || firstSeparator) {
                    currentColumn++
                    panel.add(
                        JLabel(separator).apply { if (opaqueSeparator) makeOpaque(this, 50) },
                        baseGridConstraints(0, column = currentColumn, indent = 0)
                    )
                }
                currentColumn++
                panel.add(positionLabel, baseGridConstraints(0, column = currentColumn, indent = 0))
            }
        }
        return currentColumn
    }

    private fun makeOpaque(component: JComponent, alpha: Int) {
        component.foreground = Color(
            component.foreground.red,
            component.foreground.green,
            component.foreground.blue,
            alpha)
    }

    private fun getOverviewPanel(): JPanel {
        val overviewPanel = JPanel()
        overviewPanel.layout = GridLayoutManager(2, 1, Insets(0, 5, 0, 0), -1, 0)

        // don't remove that!
        // Some magic (side-effect?) happens when JBHtmlEditorKit() initializing
        // that make html tags like <em>, <p>, <ul> etc. be treated properly inside JEditorPane
        // PS occasionally found that when played with com.intellij.util.ui.HtmlPanel
        // PSS Good luck if you try to understand the reason of that magic (customStyleSheet?)... I gave up...
        JBHtmlEditorKit()

        val descriptionPane = JEditorPane(
            "text/html",
            "<html>" + getDescriptionAsHtml() + "</html>"
        ).apply {
            this.isEditable = false
            this.background = UIUtil.getPanelBackground()
            this.preferredSize = Dimension() // this is the key part for shrink/grow.

            // add a CSS rule to force body tags to use the default label font
            // instead of the value in javax.swing.text.html.default.csss
            val font = UIUtil.getLabelFont()
            val fontColor = UIUtil.getTextFieldForeground()
            val bodyRule = UIUtil.displayPropertiesToCSS(font, fontColor) +
                "a { color: #${ColorUtil.toHex(JBUI.CurrentTheme.Link.linkColor())}; }"
            (this.document as HTMLDocument).styleSheet.addRule(bodyRule)

            // open clicked link in browser
            this.addHyperlinkListener {
                BrowserHyperlinkListener.INSTANCE.hyperlinkUpdate(it)
            }
        }

        overviewPanel.add(descriptionPane,
            panelGridConstraints(1)
        )
        return overviewPanel
    }

    private fun getDescriptionAsHtml(): String {
        val overviewMarkdownStr = vulnerability.description//getOverview()

        val parser = Parser.builder().build()
        val document = parser.parse(overviewMarkdownStr)

        val renderer = HtmlRenderer.builder().escapeHtml(true).build()

        return renderer.render(document)
    }
}
