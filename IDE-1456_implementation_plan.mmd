sequenceDiagram
    participant User
    participant IDE as IntelliJ IDE
    participant Configurable as SnykProjectSettingsConfigurable
    participant HTMLPanel as HTMLSettingsPanel
    participant JCEF as JBCefBrowser
    participant Handler as SaveConfigHandler
    participant LSW as LanguageServerWrapper
    participant LS as Language Server
    participant Settings as SnykApplicationSettings
    participant Resources as Plugin Resources

    User->>IDE: Open Snyk Settings
    IDE->>Configurable: createComponent()
    
    alt Registry key snyk.useNewConfigDialog = true
        Configurable->>HTMLPanel: new HTMLSettingsPanel(project)
        HTMLPanel->>LSW: isLanguageServerInitialized()
        
        alt Language Server available
            LSW-->>HTMLPanel: true
            HTMLPanel->>LSW: getConfigHtml()
            LSW->>LS: executeCommand("snyk.workspace.configuration")
            LS-->>LSW: HTML string
            LSW-->>HTMLPanel: HTML string
        else Language Server NOT available (CLI not downloaded)
            LSW-->>HTMLPanel: false
            HTMLPanel->>Resources: Load settings-fallback.html
            Resources-->>HTMLPanel: Fallback HTML string
            HTMLPanel->>HTMLPanel: Subscribe to CLI_DOWNLOAD_TOPIC
        end
        
        HTMLPanel->>JCEF: loadHTML(html)
        HTMLPanel->>Handler: Register __ideSaveConfig__ callback
        HTMLPanel->>Handler: Register __ideLogin__ callback
        HTMLPanel->>Handler: Register __ideLogout__ callback
        JCEF-->>User: Display HTML form
        
        User->>JCEF: Modify settings & blur/change
        JCEF->>Handler: window.__ideSaveConfig__(jsonString)
        Handler->>Handler: Parse JSON
        Handler->>Settings: Update settings values
        
        opt CLI downloaded (was in fallback mode)
            IDE-->>HTMLPanel: cliDownloadFinished event
            HTMLPanel->>LSW: getConfigHtml()
            LSW->>LS: executeCommand("snyk.workspace.configuration")
            LS-->>LSW: Full config HTML
            LSW-->>HTMLPanel: HTML string
            HTMLPanel->>JCEF: loadHTML(fullConfigHtml)
            JCEF-->>User: Display full config form
        end
        
        User->>JCEF: Click Authenticate
        JCEF->>Handler: window.__ideLogin__()
        Handler->>LSW: login()
        
        User->>IDE: Click OK/Apply
        IDE->>Configurable: apply()
        Configurable->>HTMLPanel: apply()
        HTMLPanel->>Settings: Persist final state
        HTMLPanel->>LSW: updateConfiguration()
    else Registry key snyk.useNewConfigDialog = false
        Configurable->>IDE: Use legacy SnykSettingsDialog
    end
